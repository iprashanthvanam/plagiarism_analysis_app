name: Deploy Monolith to Azure

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - uses: actions/checkout@v4

      # 2. Build Frontend (React)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Build React App
        run: |
          cd frontend
          npm install
          CI=false npm run build

      # 3. Move Frontend Build to Backend
      - name: Move Build to Backend
        run: |
          mkdir -p backend/app/build
          # Copy contents of frontend/build to backend/app/build
          cp -r frontend/build/* backend/app/build/ || cp -r frontend/dist/* backend/app/build/

      # 4. Set up Python
      - name: Set up Python version
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 5. Build Backend (Install Dependencies to check errors)
      #    We install here just to check for errors, BUT we will NOT upload this folder.
      - name: Install Python Dependencies
        run: |
          cd backend
          python -m venv antenv
          source antenv/bin/activate
          pip install -r requirements.txt

      # 6. Zip Everything (Backend + React Build)
      #    ⚠️ CRITICAL FIX: We exclude 'antenv' to keep the file small (~50-100MB instead of 8GB)
      - name: Zip artifact for deployment
        run: |
          cd backend
          zip -r ../python-app.zip . -x "antenv/*" "__pycache__/*"

      # 7. Deploy to Azure
      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'plagiarismanalyser'
          slot-name: 'Production'
          package: python-app.zip
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
